<div class="row clearfix">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
            <div class="body">
                <ul class="nav nav-tabs tab-nav-right" id="navdiv" role="tablist">
                    <!-- <li role="presentation" class="active"><a href="#tablediv" data-toggle="tab">HOME</a></li> -->
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="row clearfix">
    <div class="col-lg-8 col-md-7 col-sm-12 col-xs-12">
        <div class="card">
            <div class="header">
                <h2 id="applicant-table-header">Applicants</h2>
            </div>
            <div class="body">
                <!-- Nav tabs -->

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane fade in active" id="tablediv">
                        <!-- <b>Home Content</b> -->
                        <table id="apllicantTable" class="table table-bordered table-striped table-hover"
                               cellspacing="0"
                               width="100%">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Name</th>
                                <th>Year</th>
                                <th>Stream</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-5 col-sm-12 col-xs-12">
        <div class="card">
            <div class="header">
                <h2>
                    Short Listed Applicants
                </h2>
            </div>
            <div class="body">
                <table id="shortListedTable" class="table table-bordered table-striped table-hover" cellspacing="0"
                       width="100%">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <!--<th>Position</th>-->
                        <th>Actions</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>


<script>
    var companyObject;

    $(document).ready(function () {
        $.ajax({
            type: "GET",
            url: "http://localhost:3000/company",
            data: {userID: userID},
            dataType: "json",
            success: function (response) {
                if (response.success == true) {
                    companyObject = response.data[0];
                    console.log(response);
                    init();
                } else {
                    showErrorMessage("Something went wrong");
                    console.log(response);
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status, error);
            }
        });
    });

    function init() {
        var selectButton = '<a class="btn btn-success btn-sm  waves-effect ajaxSelect" style = "margin-right:10px;" title="Select"> <i class="material-icons">drafts</i> </a>';
        var viewButton = '<a class="btn btn-info btn-sm  waves-effect ajaxView" style = "margin-right:10px;" title="View CV"> <i class="material-icons">drafts</i> </a>';
        var downloadButton = '<a class="btn btn-warning btn-sm  waves-effect ajaxDownload" style = "margin-right:10px;"> <i class="material-icons">save</i> </a>';
        var removeButton = '<a class="btn btn-danger btn-sm waves-effect  ajaxRemove"> Remove</a>';

        var ajaxRemove = "ajaxRemove";
        var ajaxSelect = "ajaxSelect";
        var ajaxView = "ajaxView";
        var ajaxDownload = "ajaxDownload";

        // Set positions
        var allObjects = "";
        companyObject.positions.forEach(function (t) {
            var navtab = "<li role='presentation'><a class='positionTab' href='#tablediv' data-toggle='tab'>" + t + "</a></li>"
            $("#navdiv").append(navtab);
        });
        console.log(companyObject);
        console.log($("#navdiv:first-child").first());

        var position = companyObject.positions[0];

        var applicantTable = $('#apllicantTable').DataTable({
            dom: 'Bfrtip',
            responsive: true,
            buttons: [
                'pdf', 'print'
            ],
            ajax: {
                url: 'http://localhost:3000/student_company/students',
                data: function (d) {
                    d.company = companyObject._id;
                    d.position = position;
                },
                dataSrc: 'result'
            },
            "columns": [
                {
                    "className": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": '',
                    "width": "10%"
                },
                {"data": "name"},
                {
                    "data": "year",
                    "width": "20%"
                },
                {
                    "data": "stream",
                    "width": "10%"
                },
                {
                    "width": "20%",
                    "data": null,
                    "defaultContent": viewButton + selectButton
                }
            ],
            "order": [[1, 'asc']],
            initComplete: function () {
                this.api().columns().every(function () {
                    if (this[0] == 2 || this[0] == 3) {
                        var column = this;
                        var select = $('<select><option value=""></option></select>')
                            .appendTo($(column.header()))
                            .on('change', function () {
                                var val = $.fn.dataTable.util.escapeRegex(
                                    $(this).val()
                                );
                                column
                                    .search(val ? '^' + val + '$' : '', true, false)
                                    .draw();
                            });
                        column.data().unique().sort().each(function (d, j) {
                            select.append('<option value="' + d + '">' + d + '</option>')
                        });
                    }
                });
            }
        });

        // Add event listener for opening and closing details
        $('#apllicantTable tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = applicantTable.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                row.child(format(row.data())).show();
                tr.addClass('shown');
            }
        });

        function format(d) {
            // `d` is the original data object for the row
            return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                '<tr>' +
                '<td>Full name:</td>' +
                '<td>' + d.name + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Phone number:</td>' +
                '<td>' + d.phone + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Year:</td>' +
                '<td>' + d.year + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Email:</td>' +
                '<td>' + d.email + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Stream:</td>' +
                '<td>' + d.stream + '</td>' +
                '</tr>' +
                '</table>';
        }

        var shortListedTable = $('#shortListedTable').DataTable({
            dom: 'Bfrtip',
            responsive: true,
            buttons: [
                'pdf', 'print'
            ],
            ajax: {
                url: 'http://localhost:3000/selected_student_company/students/' + companyObject._id,
                dataSrc: 'result'
            },
            "columns": [
                {"data": "student"},
//                {"data": "position"},
                {
                    "width": "20%",
                    "data": null,
                    "defaultContent": removeButton
                }
            ]
        });

        shortListedTable.on("click", "." + ajaxRemove, function () {
            var rowData = shortListedTable.row($(this).parents('tr')).data();
            var thisRow = $(this).parents('tr');
            var para = '';
            var url = 'http://localhost:3000/selected_student_company/' + rowData['_id'];
//            console.log(url + para);
            ajaxSend("DELETE", para, "ajaxRemove", thisRow, url);
        });

        applicantTable.on("click", "." + ajaxSelect, function () {
            var rowData = applicantTable.row($(this).parents('tr')).data();
            var url = "http://localhost:3000/selected_student_company";
            var thisRow = $(this).parents('tr');
            var para = '&company=' + companyObject._id + '&student=' + rowData['userID'] + '&position=' + position;
//            console.log(url + para);
            ajaxSend("POST", para, "ajaxSelect", thisRow, url);
        });

        applicantTable.on("click", "." + ajaxView, function () {
            var rowData = applicantTable.row($(this).parents('tr')).data();
            var win = window.open('http://localhost:3000/uploads/' + rowData.cv);
//            console.log(rowData.cv);
        });

        function ajaxSend(type, params, action, clickRow, url) {
            $.ajax({
                type: type,
                url: url,
                data: params,
                dataType: "json",
                success: function (response) {
                    switch (action) {
                        case "ajaxRemove":
                            if (response.status == 'success') {
                                showSuccessMessage("Student removed successfully!");
                                shortListedTable.row(clickRow).remove().draw();
                                applicantTable.ajax.reload(null, false);
                            } else {
                                showErrorMessage("Unexpected error #1, Please try again");
                                console.log(response);
                            }
                            break;

                        case "ajaxSelect":
                            if (response.status == 'success') {
                                showSuccessMessage("Student short listed successfully!");
                                applicantTable.row(clickRow).remove().draw();
                                shortListedTable.ajax.reload(null, false);
                            } else {
                                showErrorMessage("Unexpected error #2, Please try again");
                                console.log(response);
                            }
                            break;
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr);
                    showErrorMessage("Unexpected error");
                    console.log(status, error);
                }
            });
        }

        function showErrorMessage(msg) {
            swal(msg + "!", '', "error");
        }

        function showAjaxLoaderMessage() {
            swal({
                title: "Do you really want to select this company ?",
                text: "Submit to run ajax request",
                type: "info",
                showCancelButton: true,
                closeOnConfirm: false,
                showLoaderOnConfirm: true,
            }, function () {
                console.log("Hello World");
                setTimeout(function () {
                    swal("Ajax request finished!");
                }, 2000);
            });
        }

        //Changing position
        $('.positionTab').click(function () {
            position = $(this).text();
            applicantTable.ajax.reload();
        });
    }


</script>
